name: Deploy App

on:
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Is this a rollback deployment?'
        required: false
        default: 'false'

permissions:
  contents: write   # required to push with GITHUB_TOKEN

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set rollback input
        run: echo "ROLLBACK=${{ github.event.inputs.rollback }}" >> $GITHUB_ENV

      - name: Simulate Deploy
        run: echo "ðŸš€ Deploying..."  # replace with actual deploy commands

      - name: Save Deployment Metadata
        run: |
          echo '[{
           "deployment_id": "${{ github.run_id }}",
           "repo": "${{ github.repository }}",
           "status": "success",
           "rollback": '${{ env.ROLLBACK }}',
           "timestamp": "${{ github.run_started_at }}"
          }]' > deployment_logs.json


      - name: Append to Deployment History and Push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git clone https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} repo
          cd repo

          mkdir -p .github/data
          DEPLOY_LOG_FILE=".github/data/deployments.json"

          if [ ! -f "$DEPLOY_LOG_FILE" ]; then
            echo "[]" > "$DEPLOY_LOG_FILE"
          fi

          jq --argjson new_entry "$(cat ../deployment_logs.json | jq '.[0]')" \
             '. += [$new_entry]' "$DEPLOY_LOG_FILE" > tmp.json && mv tmp.json "$DEPLOY_LO]()
