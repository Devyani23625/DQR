name: Deploy App

on:
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Is this a rollback deployment?'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set rollback input
        run: echo "ROLLBACK=${{ github.event.inputs.rollback }}" >> $GITHUB_ENV

      - name: Simulate Deploy
        run: echo "Deploying..."  # replace with actual deploy

      - name: Save Deployment Metadata
        run: |
          echo '[{
            "deployment_id": "${{ github.run_id }}",
            "repo": "${{ github.repository }}",
            "status": "success",
            "rollback": '${{ env.ROLLBACK }}',
            "timestamp": "${{ github.run_started_at }}"
          }]' > deployment_logs.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-log
          path: deployment_logs.json
  dqr:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Download Deployment Log Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-log
          path: .github/scripts

      - name: Run DQR Script
        run: node .github/scripts/calculate-dqr.js     
